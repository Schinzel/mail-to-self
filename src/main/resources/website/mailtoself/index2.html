<!DOCTYPE html>
<html>
<!--#include file="includes/header.html" -->


<script>
    function init() {
        Tabs.render('tabs');
        Sender.render('sender');
        goToSend();
    }

    var Tabs = (function () {
        function _toggleTabs() {
            //Remove active tab class from previously selected tab
            document.getElementsByClassName("activeTab")[0].classList.remove("activeTab");
            //Set argument tab to be active tab
            event.target.classList.add('activeTab');
        }

        function _createTab(accountId, accountName, isActiveTab) {
            var div = document.createElement('div');
            div.classList.add('tab');
            if (isActiveTab) {
                div.classList.add('activeTab');
            }
            div.onclick = _toggleTabs;
            div.innerHTML = accountName;
            div.dataset.accountId = accountId;
            return div;
        }

        return {
            render: function (elementId) {
                document.getElementById(elementId).innerHTML = '';
                var accountIds = Accounts.getAccountIds();
                if (accountIds && accountIds.length > 0) {
                    for (var i = 0; i < accountIds.length; i++) {
                        var isActiveTab = (i === 0);
                        var accountName = Accounts.getAccountName(accountIds[i]);
                        var div = _createTab(accountIds[i], accountName, isActiveTab);
                        document.getElementById(elementId).appendChild(div);
                    }
                }
            },
            isNotEmpty: function () {
                return document.getElementsByClassName("activeTab")[0] !== undefined;
            },
            getIdOfActiveTab: function () {
                var activeTab = document.getElementsByClassName("activeTab")[0];
                return activeTab ? activeTab.dataset.accountId : "";
            }
        };
    }());


    var AccountSaver = (function () {
        var mOnSaveDoneFunction;
        var mAccountId;
        var mHtml = ''
            + '<label for="account_name">Name</label>'
            + '<input type="text" id="account_name">'
            + '<label for="user_name">Gmail Username</label>'
            + '<input type="text" id="user_name">'
            + '<label for="password">Gmail Password</label>'
            + '<input type="password" id="password">'
            + '<button type="button" id="save_account">Save</button>'
            + '<button type="button" id="remove_account">Remove Account</button>';


        function _saveSettings() {
            var password = document.getElementById("password").value;
            if (!password) {
                notify("Dude. You forgot to set the password..");
                return;
            }
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                _saveToLocalStorage(xhr.responseText);
            };
            xhr.open("post", "/call/encryptPassword", true);
            //Encode so that can send special chars
            var mailContent = encodeURIComponent(password);
            xhr.send("Password=" + mailContent);
        }


        function _saveToLocalStorage(encryptedPassword) {
            var accountName = document.getElementById("account_name").value;
            var userName = document.getElementById("user_name").value;
            if (!accountName || !userName) {
                notify("Dude. You forgot to set the account name or user name...");
                return;
            }
            Accounts.saveAccount(mAccountId, accountName, userName, encryptedPassword);
            notify('Saved settings');
            mOnSaveDoneFunction();
        }


        function _removeAccount() {
            Accounts.removeAccount(mAccountId);
            notify('Account removed');
            mOnSaveDoneFunction();
        }


        return {
            render: function (elementId, onSaveDoneFunction, accountId, accountName, userName) {
                mOnSaveDoneFunction = onSaveDoneFunction;
                mAccountId = accountId;
                document.getElementById(elementId).innerHTML = mHtml;
                document.getElementById("account_name").value = accountName;
                document.getElementById("user_name").value = userName;
                document.getElementById("password").value = "";
                document.getElementById("save_account").onclick = _saveSettings;
                document.getElementById("remove_account").onclick = _removeAccount;
            }
        }
    }());


    function goToSettings() {
        document.getElementById("areaSend").style.display = "none";
        document.getElementById("areaSettings").style.display = "block";
        if (Tabs.isNotEmpty()) {
            var accountId = Tabs.getIdOfActiveTab();
            var accountName = Accounts.getAccountName(accountId);
            var userName = Accounts.getUserName(accountId);
            AccountSaver.render('accountSaver', goToSend, accountId, accountName, userName);
        }
    }


    function createNewAccount() {
        var accountId = Accounts.getRandomAccountId();
        AccountSaver.render('accountSaver', goToSend, accountId, '', '');
    }


    function goToSend() {
        Tabs.render('tabs');
        document.getElementById("areaSend").style.display = "block";
        document.getElementById("areaSettings").style.display = "none";
    }


    var Sender = (function () {
        function _send() {
            //The the message to email
            var mailContent = document.getElementById("mailContent").value;
            //If there was no message to send
            if (!mailContent) {
                return;
            }
            var xhr = new XMLHttpRequest();
            //Set callback to invoke on successful response from server
            xhr.onload = function () {
                //Empty message input box
                document.getElementById("mailContent").value = "";
                //Show server response to user
                notify(xhr.responseText);
                //Put focus in input box for user to start typing a new message
                document.getElementById("mailContent").focus();
            };
            //Create request
            xhr.open("post", "/call/mailMe", true);
            var id = Tabs.getIdOfActiveTab();
            var userName = Accounts.getUserName(id);
            var password = Accounts.getEncryptedPassword(id);
            //Send request to server
            xhr.send(
                "Message=" + encodeURIComponent(mailContent)
                + "&Username=" + encodeURIComponent(userName)
                + "&Password=" + encodeURIComponent(password)
            );
        }

        return {
            render: function (elementId) {
                var textarea = document.createElement('textarea');
                textarea.id = 'mailContent';
                textarea.placeholder = 'Mail content here...';
                textarea.onkeypress = function () {
                    if (event.keyCode === 13) _send();
                };
                var saveButton = document.createElement('button');
                saveButton.type = 'button';
                saveButton.innerText = 'SEND';
                saveButton.onclick = _send;
                document.getElementById(elementId).appendChild(textarea);
                document.getElementById(elementId).appendChild(saveButton);
            }
        };
    }());

</script>


<body>
<h1>Mail To Self</h1>

<div id="areaSend">
    <div id="tabs"></div>
    <div id="sender"></div>
    <a href="javascript:goToSettings();">Settings</a>
</div>

<div id="areaSettings">
    <h1>Settings</h1>
    <div id="accountSaver"></div>
    <button type="button" onClick="createNewAccount();">Add Account</button>
    <a href="javascript:goToSend();">Back</a>
</div>

<script>init();</script>
</body>
</html>