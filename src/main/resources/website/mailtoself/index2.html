<!DOCTYPE html>
<html>
<!--#include file="includes/header.html" -->


<script>
    function init() {
        Tabs.renderTabs('tabs');
        goToSend();
    }

    var Tabs = (function () {
        function _toggleTabs() {
            //Remove active tab class from previously selected tab
            document.getElementsByClassName("activeTab")[0].classList.remove("activeTab");
            //Set argument tab to be active tab
            event.target.classList.add('activeTab');
        }

        function _createTab(accountId, accountName, isActiveTab) {
            var div = document.createElement('div');
            div.classList.add('tab');
            if (isActiveTab) {
                div.classList.add('activeTab');
            }
            div.addEventListener("click", _toggleTabs)
            div.innerHTML = accountName;
            div.dataset.accountId = accountId;
            return div;
        }

        return {
            renderTabs: function (elementId) {
                var accountIds = Accounts.getAccountIds();
                if (accountIds && accountIds.length > 1) {
                    for (var i = 0; i < accountIds.length; i++) {
                        var isActiveTab = (i === 0);
                        var accountName = Accounts.getAccountName(accountIds[i]);
                        var div = _createTab(accountIds[i], accountName, isActiveTab);
                        document.getElementById(elementId).appendChild(div);
                    }
                }
            },
            getIdOfActiveTab: function () {
                return document.getElementsByClassName("activeTab")[0].dataset.accountId;
            }
        };
    }());


    function send() {
        //The the message to email
        var mailContent = document.getElementById("mailContent").value;
        //If there was no message to send
        if (!mailContent) {
            return;
        }
        var xhr = new XMLHttpRequest();
        //Set callback to invoke on successful response from server
        xhr.onload = function () {
            //Empty message input box
            document.getElementById("mailContent").value = "";
            //Show server response to user
            notify(xhr.responseText);
            //Put focus in input box for user to start typing a new message
            document.getElementById("mailContent").focus();
        };
        //Create request
        xhr.open("post", "/call/mailMe", true);
        var id = Tabs.getIdOfActiveTab();
        var userName = Accounts.getUserName(id);
        var password = Accounts.getEncryptedPassword(id);
        //Send request to server
        xhr.send(
            "Message=" + encodeURIComponent(mailContent)
            + "&Username=" + encodeURIComponent(userName)
            + "&Password=" + encodeURIComponent(password)
        );
    }

    function goToSettings() {
        document.getElementById("areaSend").style.display = "none";
        document.getElementById("areaSettings").style.display = "block";
        var accountId = Tabs.getIdOfActiveTab();
        document.getElementById("account_name").value = Accounts.getAccountName(accountId);
        document.getElementById("user_name").value = Accounts.getUserName(accountId);
        document.getElementById("password").value = "";
    }

    function goToSend() {
        document.getElementById("areaSend").style.display = "block";
        document.getElementById("areaSettings").style.display = "none";
    }


    function saveSettings() {
        var password = document.getElementById("password").value;
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            saveToLocalStorage(xhr.responseText);
        };
        xhr.open("post", "/call/encryptPassword", true);
        //Encode so that can send special chars
        var mailContent = encodeURIComponent(password);
        xhr.send("Password=" + mailContent);
    }


    function saveToLocalStorage(encryptedPassword) {
        var accountId = Tabs.getIdOfActiveTab();
        var accountName = document.getElementById("account_name").value;
        var userName = document.getElementById("user_name").value;
        Accounts.saveAccount(accountId, accountName, userName, encryptedPassword);
        notify('Saved settings');
    }
</script>


<body>
<h1>Mail To Self</h1>
<div id="tabs"></div>

<div id="areaSend">
    <textarea
            type="text"
            id="mailContent"
            onkeypress="if (event.keyCode===13) send();"
            placeholder="Mail content here...">
    </textarea>

    <button
            type="button"
            onClick="send();">SEND
    </button>
    <a href="javascript:goToSettings();">Settings</a>
</div>

<div id="areaSettings">
    <h1>Settings</h1>

    <label for="account_name">Name</label>
    <input type="text" id="account_name">

    <label for="user_name">Gmail Username</label>
    <input type="text" id="user_name">

    <label for="password">Gmail Password</label>
    <input type="password" id="password">

    <button type="button" onClick="saveSettings();">SAVE</button>
    <button type="button" onClick="">ADD ACCOUNT</button>
    <a href="javascript:goToSend();">Back</a>
</div>

<script>init();</script>
</body>
</html>